trigger:
  branches:
    include:
      - master
      - main
  paths:
    include:
      - mobile/*

parameters:
  - name: platform
    displayName: '建置平台'
    type: string
    default: 'all'
    values:
      - all
      - android
      - ios
  - name: profile
    displayName: '建置設定檔'
    type: string
    default: 'preview'
    values:
      - preview
      - production
      - development

pool:
  vmImage: 'macos-latest'

variables:
  - name: nodeVersion
    value: '18.x'
  - name: workingDirectory
    value: 'mobile'

stages:
- stage: Build
  displayName: '建置應用程式'
  jobs:
  - job: BuildApp
    displayName: '執行 EAS Build'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: '安裝 Node.js $(nodeVersion)'

    - script: |
        npm install -g eas-cli@latest
        eas --version
      displayName: '安裝 EAS CLI'

    - script: |
        cd $(workingDirectory)
        npm ci
      displayName: '安裝專案依賴'

    - script: |
        cd $(workingDirectory)
        eas whoami
      displayName: '檢查 EAS 登入狀態'
      env:
        EXPO_TOKEN: $(EXPO_TOKEN)
      continueOnError: true

    - script: |
        cd $(workingDirectory)
        eas login --non-interactive
      displayName: '登入 EAS'
      env:
        EXPO_TOKEN: $(EXPO_TOKEN)

    - script: |
        cd $(workingDirectory)
        if [ "${{ parameters.platform }}" == "all" ]; then
          echo "開始打包 Android 和 iOS..."
          eas build --platform android --profile ${{ parameters.profile }} --non-interactive --wait
          eas build --platform ios --profile ${{ parameters.profile }} --non-interactive --wait
        elif [ "${{ parameters.platform }}" == "android" ]; then
          echo "開始打包 Android..."
          eas build --platform android --profile ${{ parameters.profile }} --non-interactive --wait
        elif [ "${{ parameters.platform }}" == "ios" ]; then
          echo "開始打包 iOS..."
          eas build --platform ios --profile ${{ parameters.profile }} --non-interactive --wait
        fi
      displayName: '執行 EAS Build (${{ parameters.platform }})'
      env:
        EXPO_TOKEN: $(EXPO_TOKEN)

    - script: |
        cd $(workingDirectory)
        eas build:list --platform ${{ parameters.platform }} --limit 1 --json > build-info.json
        cat build-info.json
      displayName: '取得建置資訊'
      condition: always()
      env:
        EXPO_TOKEN: $(EXPO_TOKEN)

    - task: PublishBuildArtifacts@1
      displayName: '發布建置資訊'
      condition: always()
      inputs:
        pathToPublish: '$(workingDirectory)/build-info.json'
        artifactName: 'build-info'
        publishLocation: 'pipeline'
