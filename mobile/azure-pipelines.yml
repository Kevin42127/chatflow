# Azure Pipelines for React Native iOS Build
trigger:
  branches:
    include:
    - main
    - develop
    - release/*

pr:
  branches:
    include:
    - main
    - develop

pool:
  vmImage: 'macOS-latest'

variables:
  nodeVersion: '18.x'
  expoCliVersion: 'latest'
  # 連接 Variable Group
  - group: mobile-app-secrets

stages:
- stage: Build
  displayName: Build Stage
  jobs:
  - job: Build_iOS
    displayName: Build iOS App
    timeoutInMinutes: 60
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Install Node.js'

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'
      addToPath: true
      displayName: 'Install Python'

    - script: |
        npm install -g @expo/cli eas-cli
      displayName: 'Install Expo CLI and EAS CLI'

    - script: |
        npm install
      displayName: 'Install npm dependencies'
      workingDirectory: '$(Build.SourcesDirectory)'

    - script: |
        eas --version
        eas whoami
      displayName: 'Verify EAS CLI installation'
      env:
        EXPO_TOKEN: $(EXPO_TOKEN)

    - script: |
        eas build --platform ios --profile preview --non-interactive
      displayName: 'Build iOS App with EAS'
      env:
        EXPO_TOKEN: $(EXPO_TOKEN)
        APPLE_ID: $(APPLE_ID)
        APPLE_PASSWORD: $(APPLE_PASSWORD)
        APPLE_TEAM_ID: $(APPLE_TEAM_ID)

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'ios-build'
        publishLocation: 'Container'
      displayName: 'Publish Build Artifacts'
      condition: succeededOrFailed()

# Release pipeline for production builds
- stage: Release
  displayName: Release Stage
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: Release_iOS
    displayName: Release iOS App
    timeoutInMinutes: 60
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Install Node.js'

    - script: |
        npm install -g @expo/cli eas-cli
      displayName: 'Install Expo CLI and EAS CLI'

    - script: |
        npm install
      displayName: 'Install npm dependencies'
      workingDirectory: '$(Build.SourcesDirectory)'

    - script: |
        eas build --platform ios --profile production --non-interactive
      displayName: 'Build Production iOS App'
      env:
        EXPO_TOKEN: $(EXPO_TOKEN)
        APPLE_ID: $(APPLE_ID)
        APPLE_PASSWORD: $(APPLE_PASSWORD)
        APPLE_TEAM_ID: $(APPLE_TEAM_ID)

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'ios-release'
        publishLocation: 'Container'
      displayName: 'Publish Release Artifacts'
