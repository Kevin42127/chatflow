trigger:
  branches:
    include:
      - master
      - main
  paths:
    include:
      - mobile/*

parameters:
  - name: platform
    displayName: '建置平台'
    type: string
    default: 'ios'
    values:
      - android
      - ios
  - name: profile
    displayName: '建置設定檔'
    type: string
    default: 'preview'
    values:
      - preview
      - production
      - development

pool:
  vmImage: 'macos-latest'

variables:
  - name: nodeVersion
    value: '18.x'
  - name: workingDirectory
    value: 'mobile'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '$(nodeVersion)'
  displayName: '安裝 Node.js $(nodeVersion)'

- script: |
    npm install -g eas-cli@latest
    eas --version
  displayName: '安裝 EAS CLI'

- script: |
    cd $(workingDirectory)
    npm ci
  displayName: '安裝專案依賴'

- script: |
    cd $(workingDirectory)
    if [ -z "$(EXPO_TOKEN)" ]; then
      echo "錯誤: EXPO_TOKEN 未設定"
      echo "請在 Pipeline 設定中新增變數 EXPO_TOKEN"
      exit 1
    fi
    eas whoami
  displayName: '檢查 EAS 登入狀態'
  env:
    EXPO_TOKEN: $(EXPO_TOKEN)
  continueOnError: true

- script: |
    cd $(workingDirectory)
    eas login --non-interactive
  displayName: '登入 EAS'
  env:
    EXPO_TOKEN: $(EXPO_TOKEN)

- script: |
    cd $(workingDirectory)
    echo "開始打包 ${{ parameters.platform }}..."
    eas build --platform ${{ parameters.platform }} --profile ${{ parameters.profile }} --non-interactive --wait
  displayName: '執行 EAS Build (${{ parameters.platform }})'
  env:
    EXPO_TOKEN: $(EXPO_TOKEN)

- script: |
    cd $(workingDirectory)
    eas build:list --platform ${{ parameters.platform }} --limit 1 --json > build-info.json
    cat build-info.json
  displayName: '取得建置資訊'
  condition: always()
  env:
    EXPO_TOKEN: $(EXPO_TOKEN)

- task: PublishBuildArtifacts@1
  displayName: '發布建置資訊'
  condition: always()
  inputs:
    pathToPublish: '$(workingDirectory)/build-info.json'
    artifactName: 'build-info'
    publishLocation: 'pipeline'
